import{user,repoUrl}from"./auth.js";import{env}from"../env.js";const apiBaseUrl=`${repoUrl.origin}/api/v4`;let currentUser;const userAvailable=new Promise(e=>{user.subscribe(t=>{currentUser=t,e()})}),capitalizeFirstLetter=e=>e.charAt(0).toUpperCase()+e.slice(1);export async function publish(e,t,n){if(await userAvailable,!currentUser.isAuthenticated)throw new Error("Authentication required");const i=repoUrl.pathname.slice(1),d=`${apiBaseUrl}`+`/projects/${encodeURIComponent(i)}`+"/repository/commits",a={"Content-Type":"application/json",Authorization:`Bearer ${currentUser.tokens.access_token}`},r=e=>e.split(",")[1];let o=[];e.forEach(e=>{o.push({action:t,file_path:e.file,encoding:n,content:n==="base64"?r(e.contents):e.contents})});let c=capitalizeFirstLetter(t)+" "+(e.length>1?e.length+" files":e[0].file);const l={branch:env.cms.branch,commit_message:c,actions:o},s=await fetch(d,{method:"POST",headers:a,body:JSON.stringify(l)});if(s.ok)console.log("Successfully published!");else{const{error:e,message:t}=await s.json();throw new Error(`Publish failed: ${e||t}`)}}